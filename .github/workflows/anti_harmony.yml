# 工作流名称
name: Anti Harmony Commit Filter

# 触发条件：每次 push 时运行
on:
  push:
    branches:
      - main
      - master

jobs:
  anti-harmony:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1️⃣ 检出仓库
      - name: Check out repository
        uses: actions/checkout@v4

      # 2️⃣ 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3️⃣ 创建反和谐 Python 脚本
      - name: Create Anti-Harmony script
        run: |
          cat > anti_harmony.py <<'EOF'
          import subprocess

          ANTI_HARMONY_DICT = { 
              "匕见": "荆轲", "虎狼": "吕布", "周照": "武则天", "莲偶": "哪吒", "重瞳": "项羽",
              "忠贞": "秦良玉", "祖政": "始皇帝", "雏罂": "虞美人", "丹驹": "赤兔马", "晋帝": "司马懿",
              "琰女": "杨贵妃", "瞑生院": "杀生院", "歌果": "美杜莎", "爱迪·萨奇": "爱德华·蒂奇",
              "雾都弃子": "开膛手杰克", "西行者": "玄奘三藏", "方巿": "徐福", "吾绰": "呼延灼","暗匿者":"暗杀者","【{0}】":"[{0}]"
          }

          def get_last_commit_message():
              """获取最后一次提交的 commit message"""
              result = subprocess.run(
                  ["git", "log", "-1", "--pretty=%B"],
                  capture_output=True, text=True
              )
              return result.stdout.strip()

          def replace_text(text):
              """执行字典替换"""
              for k, v in ANTI_HARMONY_DICT.items():
                  text = text.replace(k, v)
              return text

          def update_commit_message(new_message):
              """更新并推送新的 commit message"""
              subprocess.run(["git", "commit", "--amend", "-m", new_message], check=True)
              subprocess.run(["git", "push", "--force"], check=True)

          if __name__ == "__main__":
              original_message = get_last_commit_message()
              new_message = replace_text(original_message)

              print(f"原始提交信息: {original_message}")
              print(f"替换后提交信息: {new_message}")

              if original_message != new_message:
                  print("🔄 检测到需要替换的内容，正在更新 commit message...")
                  update_commit_message(new_message)
              else:
                  print("✅ 未检测到需要替换的词汇，无需修改。")
          EOF

      # 4️⃣ 执行反和谐脚本
      - name: Run Anti-Harmony script
        run: |
          python anti_harmony.py
