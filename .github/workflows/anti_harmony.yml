# å·¥ä½œæµåç§°
name: Anti Harmony JSON Content Replacer

# è§¦å‘æ¡ä»¶ï¼šæ¯æ¬¡ push æ—¶è¿è¡Œ
on:
  push:
    branches:
      - main
      - master
    paths:
      - '**.json' # ä»…åœ¨ json æ–‡ä»¶å‘ç”Ÿå˜åŠ¨æˆ–æ™®é€š push æ—¶è§¦å‘

jobs:
  anti-harmony-files:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤

      # 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3ï¸âƒ£ åˆ›å»ºå¹¶æ‰§è¡Œåå’Œè° Python è„šæœ¬ (é’ˆå¯¹æ–‡ä»¶å†…å®¹)
      - name: Run Anti-Harmony File Script
        run: |
          cat > replace_json_content.py <<'EOF'
          import os

          # ä½ çš„å­—å…¸é…ç½®
          ANTI_HARMONY_DICT = { 
              "åŒ•è§": "è†è½²", "è™ç‹¼": "å•å¸ƒ", "å‘¨ç…§": "æ­¦åˆ™å¤©", "è²å¶": "å“ªå’", "é‡ç³": "é¡¹ç¾½",
              "å¿ è´": "ç§¦è‰¯ç‰", "ç¥–æ”¿": "å§‹çš‡å¸", "é›ç½‚": "è™ç¾äºº", "ä¸¹é©¹": "èµ¤å…”é©¬", "æ™‹å¸": "å¸é©¬æ‡¿",
              "ç°å¥³": "æ¨è´µå¦ƒ", "ç‘ç”Ÿé™¢": "æ€ç”Ÿé™¢", "æ­Œæœ": "ç¾æœè", "çˆ±è¿ªÂ·è¨å¥‡": "çˆ±å¾·åÂ·è’‚å¥‡",
              "é›¾éƒ½å¼ƒå­": "å¼€è†›æ‰‹æ°å…‹", "è¥¿è¡Œè€…": "ç„å¥˜ä¸‰è—", "æ–¹å·¿": "å¾ç¦", "å¾ç»°": "å‘¼å»¶ç¼",
              "æš—åŒ¿è€…": "æš—æ€è€…", "ã€{0}ã€‘": "[{0}]"
          }

          def scan_and_replace():
              has_changes = False
              # éå†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
              for root, dirs, files in os.walk("."):
                  # æ’é™¤ .git ç›®å½•
                  if ".git" in dirs:
                      dirs.remove(".git")
                  
                  for file in files:
                      # åªå¤„ç† .json æ–‡ä»¶
                      if file.endswith(".json"):
                          file_path = os.path.join(root, file)
                          
                          try:
                              with open(file_path, 'r', encoding='utf-8') as f:
                                  content = f.read()
                              
                              new_content = content
                              for key, value in ANTI_HARMONY_DICT.items():
                                  if key in new_content:
                                      new_content = new_content.replace(key, value)
                              
                              if content != new_content:
                                  print(f"ğŸ”„ æ­£åœ¨ä¿®æ”¹æ–‡ä»¶: {file_path}")
                                  with open(file_path, 'w', encoding='utf-8') as f:
                                      f.write(new_content)
                                  has_changes = True
                          except Exception as e:
                              print(f"âŒ è¯»å–æ–‡ä»¶å‡ºé”™ {file_path}: {e}")

              return has_changes

          if __name__ == "__main__":
              if scan_and_replace():
                  print("DETECT_CHANGE=true")
              else:
                  print("DETECT_CHANGE=false")
          EOF
          
          # è¿è¡Œè„šæœ¬å¹¶æ•è·æ˜¯å¦æœ‰æ›´æ”¹
          python replace_json_content.py > result.log
          cat result.log
          if grep -q "DETECT_CHANGE=true" result.log; then
            echo "CHANGES_FOUND=true" >> $GITHUB_ENV
          else
            echo "CHANGES_FOUND=false" >> $GITHUB_ENV
          fi

      # 4ï¸âƒ£ æäº¤æ›´æ”¹ (å¦‚æœæœ‰å˜åŠ¨)
      - name: Commit and Push changes
        if: env.CHANGES_FOUND == 'true'
        run: |
          git config --global user.name "Anti-Harmony Bot"
          git config --global user.email "bot@noreply.github.com"
          
          git add .
          # æ³¨æ„ï¼šåœ¨ commit message ä¸­åŠ å…¥ [skip ci] æ˜¯ä¸ºäº†é˜²æ­¢æ­»å¾ªç¯
          # å¦åˆ™è¿™æ¬¡æäº¤åˆä¼šè§¦å‘ workflowï¼Œé€ æˆæ— é™å¾ªç¯
          git commit -m "chore: Auto-replace harmony terms in JSON files [skip ci]"
          
          git push
