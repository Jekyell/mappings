# å·¥ä½œæµåç§°
name: Anti Harmony Commit Filter

# è§¦å‘æ¡ä»¶ï¼šæ¯æ¬¡ push æ—¶è¿è¡Œ
on:
  push:
    branches:
      - main
      - master

jobs:
  anti-harmony:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Check out repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3ï¸âƒ£ åˆ›å»ºåå’Œè° Python è„šæœ¬
      - name: Create Anti-Harmony script
        run: |
          cat > anti_harmony.py <<'EOF'
          import subprocess

          ANTI_HARMONY_DICT = { 
              "åŒ•è§": "è†è½²", "è™Žç‹¼": "å•å¸ƒ", "å‘¨ç…§": "æ­¦åˆ™å¤©", "èŽ²å¶": "å“ªå’", "é‡çž³": "é¡¹ç¾½",
              "å¿ è´ž": "ç§¦è‰¯çŽ‰", "ç¥–æ”¿": "å§‹çš‡å¸", "é›ç½‚": "è™žç¾Žäºº", "ä¸¹é©¹": "èµ¤å…”é©¬", "æ™‹å¸": "å¸é©¬æ‡¿",
              "ç°å¥³": "æ¨è´µå¦ƒ", "çž‘ç”Ÿé™¢": "æ€ç”Ÿé™¢", "æ­Œæžœ": "ç¾ŽæœèŽŽ", "çˆ±è¿ªÂ·è¨å¥‡": "çˆ±å¾·åŽÂ·è’‚å¥‡",
              "é›¾éƒ½å¼ƒå­": "å¼€è†›æ‰‹æ°å…‹", "è¥¿è¡Œè€…": "çŽ„å¥˜ä¸‰è—", "æ–¹å·¿": "å¾ç¦", "å¾ç»°": "å‘¼å»¶ç¼","æš—åŒ¿è€…":"æš—æ€è€…","ã€{0}ã€‘":"[{0}]"
          }

          def get_last_commit_message():
              """èŽ·å–æœ€åŽä¸€æ¬¡æäº¤çš„ commit message"""
              result = subprocess.run(
                  ["git", "log", "-1", "--pretty=%B"],
                  capture_output=True, text=True
              )
              return result.stdout.strip()

          def replace_text(text):
              """æ‰§è¡Œå­—å…¸æ›¿æ¢"""
              for k, v in ANTI_HARMONY_DICT.items():
                  text = text.replace(k, v)
              return text

          def update_commit_message(new_message):
              """æ›´æ–°å¹¶æŽ¨é€æ–°çš„ commit message"""
              subprocess.run(["git", "commit", "--amend", "-m", new_message], check=True)
              subprocess.run(["git", "push", "--force"], check=True)

          if __name__ == "__main__":
              original_message = get_last_commit_message()
              new_message = replace_text(original_message)

              print(f"åŽŸå§‹æäº¤ä¿¡æ¯: {original_message}")
              print(f"æ›¿æ¢åŽæäº¤ä¿¡æ¯: {new_message}")

              if original_message != new_message:
                  print("ðŸ”„ æ£€æµ‹åˆ°éœ€è¦æ›¿æ¢çš„å†…å®¹ï¼Œæ­£åœ¨æ›´æ–° commit message...")
                  update_commit_message(new_message)
              else:
                  print("âœ… æœªæ£€æµ‹åˆ°éœ€è¦æ›¿æ¢çš„è¯æ±‡ï¼Œæ— éœ€ä¿®æ”¹ã€‚")
          EOF

      # 4ï¸âƒ£ æ‰§è¡Œåå’Œè°è„šæœ¬
      - name: Run Anti-Harmony script
        run: |
          python anti_harmony.py
