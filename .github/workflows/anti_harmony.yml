name: Anti Harmony JSON Content Replacer

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**.json'

jobs:
  anti-harmony-files:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run Anti-Harmony File Script
        run: |
          # ç”Ÿæˆä¸´æ—¶ Python è„šæœ¬
          cat > replace_json_content.py <<'EOF'
          import os

          ANTI_HARMONY_DICT = { 
              "åŒ•è§": "è†è½²", "è™ç‹¼": "å•å¸ƒ", "å‘¨ç…§": "æ­¦åˆ™å¤©", "è²å¶": "å“ªå’", "é‡ç³": "é¡¹ç¾½",
              "å¿ è´": "ç§¦è‰¯ç‰", "ç¥–æ”¿": "å§‹çš‡å¸", "é›ç½‚": "è™ç¾äºº", "ä¸¹é©¹": "èµ¤å…”é©¬", "æ™‹å¸": "å¸é©¬æ‡¿",
              "ç°å¥³": "æ¨è´µå¦ƒ", "ç‘ç”Ÿé™¢": "æ€ç”Ÿé™¢", "æ­Œæœ": "ç¾æœè", "çˆ±è¿ªÂ·è¨å¥‡": "çˆ±å¾·åÂ·è’‚å¥‡",
              "é›¾éƒ½å¼ƒå­": "å¼€è†›æ‰‹æ°å…‹", "è¥¿è¡Œè€…": "ç„å¥˜ä¸‰è—", "æ–¹å·¿": "å¾ç¦", "å¾ç»°": "å‘¼å»¶ç¼",
              "æš—åŒ¿è€…": "æš—æ€è€…", "ã€{0}ã€‘": "[{0}]"
          }

          def scan_and_replace():
              has_changes = False
              for root, dirs, files in os.walk("."):
                  if ".git" in dirs: dirs.remove(".git")
                  
                  for file in files:
                      if file.endswith(".json"):
                          file_path = os.path.join(root, file)
                          try:
                              with open(file_path, 'r', encoding='utf-8') as f:
                                  content = f.read()
                              
                              new_content = content
                              for key, value in ANTI_HARMONY_DICT.items():
                                  if key in new_content:
                                      new_content = new_content.replace(key, value)
                              
                              if content != new_content:
                                  print(f"ğŸ”„ ä¿®æ”¹æ–‡ä»¶: {file_path}")
                                  with open(file_path, 'w', encoding='utf-8') as f:
                                      f.write(new_content)
                                  has_changes = True
                          except Exception as e:
                              print(f"âŒ é”™è¯¯ {file_path}: {e}")
              return has_changes

          if __name__ == "__main__":
              if scan_and_replace():
                  print("DETECT_CHANGE=true")
              else:
                  print("DETECT_CHANGE=false")
          EOF
          
          # è¿è¡Œè„šæœ¬ï¼Œè®°å½•æ—¥å¿—
          python replace_json_content.py > result.log
          cat result.log

          # åˆ¤æ–­æ˜¯å¦æœ‰å˜åŠ¨
          if grep -q "DETECT_CHANGE=true" result.log; then
            echo "CHANGES_FOUND=true" >> $GITHUB_ENV
          else
            echo "CHANGES_FOUND=false" >> $GITHUB_ENV
          fi

          # ğŸ”¥ã€å…³é”®ä¿®æ”¹ã€‘åœ¨è¿™é‡Œåˆ é™¤ä¸´æ—¶è„šæœ¬å’Œæ—¥å¿—æ–‡ä»¶
          # è¿™æ ·ä¸‹é¢çš„ git add . å°±ä¸ä¼šæŠŠå®ƒä»¬åŠ è¿›å»äº†
          rm replace_json_content.py result.log

      - name: Commit and Push changes
        if: env.CHANGES_FOUND == 'true'
        run: |
          git config --global user.name "Anti-Harmony Bot"
          git config --global user.email "bot@noreply.github.com"
          
          # å› ä¸ºä¸Šé¢å·²ç» rm æ‰äº†ä¸´æ—¶æ–‡ä»¶ï¼Œè¿™é‡Œåªä¼šæ·»åŠ è¢«ä¿®æ”¹çš„ JSON
          git add .
          git commit -m "chore: Auto-replace harmony terms in JSON files [skip ci]"
          git push
